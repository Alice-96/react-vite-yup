name: Visual Regression Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

jobs:
  vrt:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: pnpm build

      - name: Run VRT tests
        continue-on-error: true
        id: vrt-test
        run: |
          pnpm test:vrt
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload test results and screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vrt-test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
            vrt/**/*-snapshots/
          retention-days: 7

      - name: Analyze test results
        if: github.event_name == 'pull_request'
        id: analyze
        run: |
          # Playwrightã®çµæœã‚’è§£æ
          if [ -d "test-results" ]; then
            FAILED_TESTS=$(find test-results -name "*.png" -path "*/test-failed-*" | wc -l)
            DIFF_IMAGES=$(find test-results -name "*-diff.png" | wc -l)
            ACTUAL_IMAGES=$(find test-results -name "*-actual.png" | wc -l)
            
            echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
            echo "diff_images=$DIFF_IMAGES" >> $GITHUB_OUTPUT
            echo "actual_images=$ACTUAL_IMAGES" >> $GITHUB_OUTPUT
            
            # å·®åˆ†ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            if [ "$DIFF_IMAGES" -gt 0 ]; then
              echo "has_differences=true" >> $GITHUB_OUTPUT
            else
              echo "has_differences=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "failed_tests=0" >> $GITHUB_OUTPUT
            echo "diff_images=0" >> $GITHUB_OUTPUT
            echo "actual_images=0" >> $GITHUB_OUTPUT
            echo "has_differences=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate diff report
        if: github.event_name == 'pull_request' && steps.analyze.outputs.has_differences == 'true'
        id: diff-report
        run: |
          # å·®åˆ†ç”»åƒã®è©³ç´°ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          if [ -d "test-results" ]; then
            echo "## ğŸ–¼ï¸ Screenshot Differences" > diff_report.md
            echo "" >> diff_report.md
            
            # å„å·®åˆ†ç”»åƒã«ã¤ã„ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            find test-results -name "*-diff.png" | while read -r diff_file; do
              # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
              base_name=$(basename "$diff_file" -diff.png)
              test_name=$(echo "$base_name" | sed 's/-[^-]*-[^-]*$//')
              
              echo "### ğŸ“¸ $test_name" >> diff_report.md
              echo "**Difference detected in:** \`$base_name\`" >> diff_report.md
              echo "" >> diff_report.md
            done
            
            echo "diff_report_exists=true" >> $GITHUB_OUTPUT
          else
            echo "diff_report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with VRT results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { failed_tests, diff_images, actual_images, has_differences } = ${{ toJson(steps.analyze.outputs) }};
            const exitCode = '${{ steps.vrt-test.outputs.exit_code }}';
            const diffReportExists = '${{ steps.diff-report.outputs.diff_report_exists }}' || 'false';
            
            let comment = '## ğŸ“¸ Visual Regression Test Results\n\n';
            
            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼
            if (exitCode === '0') {
              comment += 'âœ… **All visual tests passed - No differences detected**\n\n';
            } else if (has_differences === 'true') {
              comment += `âŒ **Visual differences detected**\n\n`;
              comment += `### ğŸ“Š Summary\n`;
              comment += `- Screenshots with differences: ${diff_images}\n`;
              comment += `- Updated screenshots: ${actual_images}\n`;
              comment += `- Failed test scenarios: ${failed_tests}\n\n`;
              
              // å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã¯å«ã‚ã‚‹
              if (diffReportExists === 'true') {
                try {
                  const diffReport = fs.readFileSync('diff_report.md', 'utf8');
                  comment += diffReport + '\n';
                } catch (error) {
                  console.log('Could not read diff report:', error);
                }
              }
              
              comment += `### ğŸ” What to do next:\n`;
              comment += `1. ğŸ“¥ [Download test results](../actions/runs/${context.runId}) to view diff images\n`;
              comment += `2. ğŸ” Review the differences to ensure changes are intentional\n`;
              comment += `3. âœ… If changes are correct, update baselines:\n`;
              comment += `   \`\`\`bash\n   pnpm test:vrt:update\n   git add vrt/\n   git commit -m "Update VRT baselines"\n   \`\`\`\n\n`;
            } else {
              comment += `âš ï¸ **Tests failed but no visual differences detected**\n\n`;
              comment += `This might indicate a test setup or execution issue.\n`;
              comment += `Please check the test logs for more information.\n\n`;
            }
            
            // ãƒ†ã‚¹ãƒˆè©³ç´°æƒ…å ±
            comment += `### ğŸ“‹ Test Details\n`;
            comment += `- **Branch**: \`${context.payload.pull_request.head.ref}\`\n`;
            comment += `- **Commit**: \`${context.payload.pull_request.head.sha.substring(0, 7)}\`\n`;
            comment += `- **Test Runner**: Playwright\n`;
            comment += `- **Browser**: Chromium\n`;
            comment += `- **Run ID**: \`${context.runId}\`\n\n`;
            
            comment += `<details>\n`;
            comment += `<summary>ğŸ”§ Troubleshooting Guide</summary>\n\n`;
            comment += `**Common causes of visual differences:**\n`;
            comment += `- Font rendering differences between environments\n`;
            comment += `- Browser version updates\n`;
            comment += `- CSS changes affecting layout or styling\n`;
            comment += `- Dynamic content (dates, random data, loading states)\n`;
            comment += `- Animation timing issues\n\n`;
            comment += `**How to fix:**\n`;
            comment += `1. ğŸ  Run tests locally: \`pnpm test:vrt\`\n`;
            comment += `2. ğŸ› Debug with UI mode: \`pnpm test:vrt:ui\`\n`;
            comment += `3. ğŸ“Š View HTML report: \`pnpm test:vrt:report\`\n`;
            comment += `4. âœ… Update baselines if changes are intentional: \`pnpm test:vrt:update\`\n`;
            comment += `5. ğŸ“¸ Check specific pages that changed\n\n`;
            comment += `**Test Pages:**\n`;
            comment += `- ğŸ  Home page (\`/\`)\n`;
            comment += `- ğŸ‘¤ User registration (\`/user-registration\`)\n`;
            comment += `- ğŸ¢ Location registration (\`/location-registration\`)\n`;
            comment += `- ğŸ“‹ User list (\`/user-list\`)\n`;
            comment += `</details>\n`;
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦æ›´æ–°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸ“¸ Visual Regression Test Results')
            );
            
            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }